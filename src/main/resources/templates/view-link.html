<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" th:replace="~{base(content=~{::main})}">
<body>
<main>
    <div class="card card-custom">
        <div class="card-body p-5">
            <!-- Link Details -->
            <div class="mb-5">
                <h2 class="fw-bold text-primary mb-4" th:text="#{view.link.details}">Link Details</h2>

                <div class="card border-info">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-link-45deg me-2"></i>
                            <span th:text="${link.name}">Link Name</span>
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-sm-4 fw-semibold" th:text="#{view.link.id}">Link ID:</div>
                            <div class="col-sm-8">
                                <code th:text="${link.id}"></code>
                                <button class="btn btn-sm btn-outline-secondary ms-2" onclick="copyToClipboard(this)" th:data-copy="${link.id}">
                                    <i class="bi bi-clipboard"></i>
                                </button>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-sm-4 fw-semibold" th:text="#{view.link.target}">Target URL:</div>
                            <div class="col-sm-8">
                                <a th:href="${link.targetUrl}" th:text="${link.targetUrl}" target="_blank" class="text-break"></a>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-sm-4 fw-semibold" th:text="#{view.link.redirect}">Redirect URL:</div>
                            <div class="col-sm-8">
                                <a th:href="${link.redirectUrl}" th:text="${link.redirectUrl}" target="_blank" class="text-break"></a>
                                <button class="btn btn-sm btn-outline-secondary ms-2" onclick="copyToClipboard(this)" th:data-copy="${link.redirectUrl}">
                                    <i class="bi bi-clipboard"></i>
                                </button>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-sm-4 fw-semibold" th:text="#{view.link.visits}">Visits:</div>
                            <div class="col-sm-8">
                                <span class="badge bg-success fs-6" th:text="${link.visits}">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Edit Form -->
            <div class="mb-5">
                <h3 class="fw-bold text-secondary mb-4" th:text="#{view.edit.title}">Edit Link</h3>

                <form th:action="@{/api/links/{id}(id=${link.id})}" th:object="${updateLinkDTO}" method="post" enctype="application/x-www-form-urlencoded">
                    <input type="hidden" name="_method" value="patch">

                    <div class="mb-4">
                        <label for="updateName" class="form-label fw-semibold" th:text="#{form.name}">Name</label>
                        <input type="text"
                               id="updateName"
                               th:field="*{name}"
                               class="form-control form-control-custom"
                               th:placeholder="#{form.name.placeholder}"
                               th:classappend="${#fields.hasErrors('name')} ? 'is-invalid' : ''">
                        <div th:if="${#fields.hasErrors('name')}" class="invalid-feedback">
                            <ul class="list-unstyled mb-0">
                                <li th:each="error : ${#fields.errors('name')}" th:text="${error}"></li>
                            </ul>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label for="updateTargetUrl" class="form-label fw-semibold" th:text="#{form.url}">Target URL</label>
                        <input type="url"
                               id="updateTargetUrl"
                               th:field="*{targetUrl}"
                               class="form-control form-control-custom"
                               th:placeholder="#{form.url.placeholder}"
                               th:classappend="${#fields.hasErrors('targetUrl')} ? 'is-invalid' : ''">
                        <div th:if="${#fields.hasErrors('targetUrl')}" class="invalid-feedback">
                            <ul class="list-unstyled mb-0">
                                <li th:each="error : ${#fields.errors('targetUrl')}" th:text="${error}"></li>
                            </ul>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label for="updatePassword" class="form-label fw-semibold" th:text="#{form.password}">Password</label>
                        <input type="password"
                               id="updatePassword"
                               th:field="*{password}"
                               class="form-control form-control-custom"
                               placeholder="Enter current password to authorize changes"
                               th:classappend="${#fields.hasErrors('password')} ? 'is-invalid' : ''">
                        <small class="form-text text-muted">
                            <i class="bi bi-shield-lock me-1"></i>
                            Required for authorization if link has password protection
                        </small>
                        <div th:if="${#fields.hasErrors('password')}" class="invalid-feedback">
                            <ul class="list-unstyled mb-0">
                                <li th:each="error : ${#fields.errors('password')}" th:text="${error}"></li>
                            </ul>
                        </div>
                    </div>

                    <div class="d-flex gap-3">
                        <button type="submit" class="btn btn-success btn-custom">
                            <i class="bi bi-check-lg me-2"></i>
                            <span th:text="#{form.update}">Update Link</span>
                        </button>
                    </div>
                </form>
            </div>

            <!-- Delete Form -->
            <div class="mb-4">
                <h3 class="fw-bold text-danger mb-4">Delete Link</h3>
                <div class="alert alert-warning" role="alert">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>Warning:</strong> This action cannot be undone. The link will be permanently deleted.
                </div>

                <form th:action="@{/api/links/{id}(id=${link.id})}" method="post" onsubmit="return confirm('Are you sure you want to delete this link?');">
                    <input type="hidden" name="_method" value="delete">

                    <div class="mb-3">
                        <label for="deletePassword" class="form-label fw-semibold">Password (if required)</label>
                        <input type="password"
                               id="deletePassword"
                               name="password"
                               class="form-control form-control-custom"
                               placeholder="Enter password if link is protected">
                    </div>

                    <button type="submit" class="btn btn-danger btn-custom">
                        <i class="bi bi-trash me-2"></i>
                        <span th:text="#{form.delete}">Delete Link</span>
                    </button>
                </form>
            </div>

            <div class="text-center">
                <a href="/" class="btn btn-outline-secondary btn-custom">
                    <i class="bi bi-arrow-left me-2"></i>
                    Back to Home
                </a>
            </div>
        </div>
    </div>

    <script>
        function copyToClipboard(button) {
            const textToCopy = button.getAttribute('data-copy');

            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(textToCopy).then(() => {
                    showCopySuccess(button);
                }).catch(err => {
                    fallbackCopy(textToCopy, button);
                });
            } else {
                fallbackCopy(textToCopy, button);
            }
        }

        function fallbackCopy(text, button) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                document.execCommand('copy');
                showCopySuccess(button);
            } catch (err) {
                console.error('Failed to copy text: ', err);
            } finally {
                document.body.removeChild(textArea);
            }
        }

        function showCopySuccess(button) {
            const originalContent = button.innerHTML;
            button.innerHTML = '<i class="bi bi-check"></i>';
            button.classList.remove('btn-outline-secondary');
            button.classList.add('btn-success');
            button.disabled = true;

            setTimeout(() => {
                button.innerHTML = originalContent;
                button.classList.remove('btn-success');
                button.classList.add('btn-outline-secondary');
                button.disabled = false;
            }, 2000);
        }
    </script>
</main>
</body>
</html>